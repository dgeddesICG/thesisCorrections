\setstretch{2}
\FloatBarrier
\section{Rationale}
The ability to discriminate and quantify the concentration of biomarkers such as FAD would enhance the assessment of retinal health and the detection of retinal disease at the stage of biochemical dysfunction rather than at the point where, often permanent, physical damage becomes apparent in the patients central vision. FAD are metabolites produced from the consumption of oxygen and by longitudinally mapping the concentration of these metabolites across the retina any abnormalities in oxygenation can signify the onset of retinal disease. In principle, the use of FAD as a biosensor for metabolic health is advantageous over existing retinal oximitery methods which measure vascular oxygen saturation and suffer from the magnitude of the error in the measurements is larger than the typical variation exhibited in the early stages of disease such Glaucoma \addcite
Technique for discriminating fluorophores using their distinct spectral signatures or their intrinsic fluorescence lifetime do exist. However, the combination of overlapping spectra, complex decay models required for fitting, and clutter in the eye corrupting the already weak return signal causes prohibitively high error in the recovered fluorophore concentration motivates the requirement for efficient and robust unmixing methods.
\\
In this chapter, the suitability and performance of existing un-mixing methods: spectral un-mixing through matrix inversion; abundance recovery through fitted lifetimes, blind unmixing with phasor-SFLIM are compared and a new, fit free, technique for unmixing SFLIM data using tensor inversion is developed and evaluated. To assess the performance of these techniques the error in the un-mixed abundance of a fluorophores is evaluated as the relative abundance of the fluorophore is varied between \num{0} and \num{1} as well as over multiple photon fluxes and spectral bands. The condition number for spectral umixing with matrix inversion and SFLIM unmxing are also compared for different sample scenarios to assess the strengths of this new technique and conclude whether measuring fluorescence lifetimes increases capabilities to quantify retinal fluorophores and if the limit lies in the complexities of the biology or a technological limit of SPAD detectors.
\FloatBarrier
\section{Lifetime Unmixing}\label{sec:lifeunmix}
In principle, retinal fluorophores could be quantified using only measurements of the fluorescence lifetime in a single spectral band - potentially negating the need the lengthy image acquisition periods associated with recorded sequential images over multiple detection bands - however an increased number of fluorophores requires more complex, noise sensitive, fitting models and prohibitively large photon fluxes. The 3 biomarkers of interest in this thesis (FAD, AGE, and A2E/Lipofuscin) all exhibit biexponential decay profiles (see \cref{tab:retlifetimes}) meaning that in order to fully recover the fluorophore abundance a 6-exponential fit is required.


\begin{table}
    \centering
    \begin{tabular}{|c|c|c|c|c|c|c|}
    \hline
    Fluorophore & $\alpha_{1}\,(\unit{\percent})$ & $\tau_{1}\,(\unit{\nano\second})$ & $\alpha_{2}\,(\unit{\percent})$ & $\tau_{2}\,(\unit{\nano\second})$ & $\langle \tau \rangle_{A}\,(\unit{\nano\second})$  & $\langle \tau \rangle_{I}\,(\unit{\nano\second})$\\
    \hline
    AGE  & 62 & 0.865 & 38 & 4.17 & 3.33 & 2.12\\
    FAD & 18 & 0.33 & 82 & 2.81 & 2.75 & 2.36\\
    A2E & 48 & 0.39 & 52 & 2.24 &  1.98 & 1.35 \\
    \hline
    \end{tabular}
    \caption{Fluorescence lifetime parameters of common retinal fluorophores FAD, AGE, and A2E / Lipofuscin resolved as biexponential decays as well as their associated intensity weighted, and amplitude weighted average lifetimes lifetimes, $\langle \tau \rangle_{I}$ and $\langle \tau \rangle_{A}$, respectively. Reproduced from~\citeauthor{schweitzer2007towards}\cite{schweitzer2007towards}}
    \label{tab:retlifetimes}
\end{table}

\subsection{Unmixing Method}
For an additive mixture of FAD, AGE, and A2E with concentrations $c_{FAD}$, $c_{AGE}$, and $c_{A2E}$ respectively~\footnotemark{}, the resulting decay model would be of the form in~\cref{eq:retmodel}. 
\begin{multline}
     I(t) =  c_{FAD}\bigg(\alpha_{FAD,1}\exp(-t / \tau_{FAD,1}) 
       + \alpha_{FAD,2}\exp(-t / \tau_{FAD,2})\bigg)\\    
      + c_{AGE}\bigg(\alpha_{AGE,1}\exp(-t / \tau_{AGE,1})
      \alpha_{AGE,2}\exp(-t / \tau_{AGE,2})\bigg)\\
      + c_{A2E}\bigg(\alpha_{A2E,1}\exp(-t / \tau_{A2E,1})
      \alpha_{A2E,2}\exp(-t / \tau_{A2E,2})\bigg)
      \label{eq:retmodel}
\end{multline}
where $\alpha_{FAD,1}$ refers to the amplitude of the first lifetime for FAD, and $c_{FAD}$ is the relative abundance of FAD. These concentrations can then be recovered from a conventional 6 exponential fit (\cref{eq:6expfit}) using \cref{eq:fitrecovery} where the parameter estimates supplied to the fitting routine are of the same order as those in \cref{eq:retmodel} and best fit parameters preserve this order i.e parameters are ordered FAD, AGE, A2E.

\footnotetext{such that $c_{FAD} + c_{AGE} + c_{A2E} = 1$}
\begin{equation}
     I_{FIT}(t) = \delta + \sum^{n = 6}_{n \geq 1} \alpha_{n}\exp(-t / \tau_{n})
     \label{eq:6expfit}
\end{equation}

\begin{align}
    \bar{c}_{FAD} &= \frac{1}{2}\Bigg(\frac{\alpha_{1}}{\alpha_{FAD,1}} + \frac{\alpha_{2}}{\alpha_{FAD,2}}\Bigg) &     \bar{c}_{AGE} &= \frac{1}{2}\Bigg(\frac{\alpha_{1}}{\alpha_{AGE,1}} + \frac{\alpha_{2}}{\alpha_{AGE,2}}\Bigg)\\
     \bar{c}_{A2E} &= \frac{1}{2}\Bigg(\frac{\alpha_{1}}{\alpha_{A2E,1}} + \frac{\alpha_{2}}{\alpha_{A2E,2}}\Bigg)\label{eq:fitrecovery}
\end{align}

To provisionally test this abundance recovery method an example, noise free, fluorescence decay was simulated using \cref{eq:retmodel} with $c_{FAD} = c_{A2E} = 0.4$, $c_{AGE} = 0.2$. The interval between each time step was set to match the temporal resolution of the SPAD array ($\delta t = \SI{47}{\pico\second}$) and the time window over which the decay was simulated matched the laser period of the NKT supercontinuum source ($T = \SI{12.8}{\nano\second}$) - equating to \num{266} time samples (\cref{eq:timebins}). A basic nonlinear least squares fitting was then performed using the \textit{Scipy} implementation of the Levenberg-Marqaurdt algorithm was used to fit the example data to the model and recover the abundances using \cref{eq:fitrecovery}. From the resulting line of best fit (\cref{fig:retfitexample}) and the recovered abundances (\cref{tab:retfitexampleresults}) it can be concluded that this method, in extremely idealised circumstances where the only source of noise would arise from the accuracy lost from a \SI{64}{\bit} floating point representation of a number, can recover the fluorophore abundances with a low, although non-zero, error.
 
\begin{equation}
    N_{time steps} = \Bigg\lfloor\frac{T}{\delta t}\Bigg\rfloor
    \label{eq:timebins}
\end{equation}

To appraise this fitting based method the sensitivity to fluorophore concentration is evaluated by simulating fluorescence lifetime data where the concentration of FAD, AGE, and A2E is smoothly varied between \numrange{0}{1} (\qtyrange{0}{100}{\percent}) in steps of \num{0.1} (\SI{10}{\percent}). These resulting abundance maps, shown in \cref{fig:sflimamaps}, aid in visualising areas where the unmixing methods falter and produce large errors. For example in  \cref{fig:retfittingnoiseless}, at low fluorophore concentrations the error in recovery rises to upwards of \SI{10}{\percent} for noiseless data i.e a fluorophore concentration of \num{0.1} would be recovered as $\approx \numrange{0.09}{0.11}$. However, at larger fluorophore concentrations, FAD, for example, can be quantified with an error $\ll \SI{1}{\percent}$. 


\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{figures//sflim//lifetime-unmixing/RetFluorFittingExampleDecay.pdf}
    \caption{Least squares fitting of a mixture of 3 retinal fluorophores FAD, AGE, A2E using a 6 exponential fitting model. The data (red crosses) and line of best fit (solid black line) is plotted (top left) as well as in log space (top right). The residuals, (line of best fit - data) is shown in the bottom plot and are on the order of \num{1e-11} indicating a good quality fit and an appropriate fitting model.}
    \label{fig:retfitexample}
\end{figure}

\begin{table}
    \centering
    \begin{tabular}{|c|c|c|c|}
        \hline
         &  Ground Truth & Recovered  &  Error $(\unit{\percent})$\\
         \hline
         $c_{FAD}$ & 0.4  & $0.4 + \num{3.1e-6}$ & \num{8e-4}\\
         $c_{AGE}$ &  0.2 & $0.2 + \num{1.8e-6}$ & \num{9e-4} \\
         $c_{A2E}$ & 0.4 & $0.4 - \num{6.3e-6}$ & \num{2e-4} \\
         \hline
    \end{tabular}
    \caption{Recovered abundances from a example fluorescence decay modelled with no noise using a 6 exponential fit}
    \label{tab:retfitexampleresults}
\end{table}



\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{figures//sflim//lifetime-unmixing/FigAbundanceMaps.pdf}
    \caption{Example abundance maps used to assess the efficacy of methods used to unmix additive mixtures of 3 fluorophores. The colour of each pixel represents the relative concentration of each fluorophores with the condition of $\sum_{n \geq 1}^{N}\alpha_{n} = 1$}
    \label{fig:sflimamaps}
\end{figure}

\begin{equation}
    \mathbf{\epsilon} = \Bigg\lvert\frac{\mathbf{c}_{n} - \bar{\mathbf{c}}_{n}}{\mathbf{c}_{n}}\Bigg\rvert
    \label{eq:recerror}
\end{equation}


\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{figures/sflim/lifetime-unmixing/RetFittingNoiseless.pdf}
    \caption{Results from recovering the abundance of retinal fluorophores from additive mixtures using their fluorescence lifetime. The fluorescence decays were simulated without noise, and the abundances were recovered (middle row) and compared to the ground truth (top row) with an error corresponding to Eq.~\ref{eq:recerror} is plotted (bottom row). Areas shaded white represent where the fluorophore concentration is 0 and so a relative error cannot be ascribed (\cref{eq:recerror}) but from comparing the recovered abundance to the ground truth it can be seen that the relative error is $< 0.01$}
    \label{fig:retfittingnoiseless}
\end{figure}
\FloatBarrier
\subsection{Sensitivity to noise}
If this technique is to be suitable for unmixing retinal fluorophores it needs to be robust to the low-photon fluxes experienced when imaging \textit{in-vivo} human retinas where typically over an acquisition period of \SI{1}{\minute} only \numrange{e3}{e4} photons are recorded~\cite{dysli2017fluorescence}. The above simulations were repeated for a variety of photon fluxes where Poissonian noise is applied in order to mimic photon shot noise in a detector. While the dark/thermal noise and read noise are present in all measurements the detector shot noise is dominant and so is the only noise source accounted for.
The photon fluxes chosen for these simulations, \numlist{e3;e5;e7;e12} account for realistic photon counts achievable using current SPAD arrays as well improvements in fill factor, and quantum efficiency, detector dead times etc. that would be expected in future generation SPAD arrays. 

% Results from fitting base unmixing
\begin{figure}
    \centering
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.62\textwidth]{figures/sflim/lifetime-unmixing/RetFitting1e3.pdf}
        \caption{}
        \label{subfig:retfitting1e3}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.62\textwidth]{figures/sflim/lifetime-unmixing/RetFitting1e5.pdf}
        \caption{}
        \label{subfig:retfitting1e5}
    \end{subfigure}
    \caption{Results from recovering the abundance of retinal fluorophores from additive mixtures using their fluorescence lifetime with the inclusion of detector shot noise for where (\subref{subfig:retfitting1e3}),(\subref{subfig:retfitting1e5}),(\subref{subfig:retfitting1e7}),(\subref{subfig:retfitting1e12}) denote photon fluxes of \numlist{e3;e5;e7;e12} respectively. The recovered abundances (middle row) are plotted with the ground truths (top row) and the error in the unmixing corresponding to Eq.~\ref{eq:recerror} is plotted (bottom row). Areas shaded white represent where the fluorophore concentration is 0 and so a relative error cannot be ascribed (\cref{eq:recerror}).}
\end{figure}
\begin{figure}\ContinuedFloat
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.62\textwidth]{figures/sflim/lifetime-unmixing/RetFitting1e7.pdf}
        \caption{}
        \label{subfig:retfitting1e7}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.62\textwidth]{figures/sflim/lifetime-unmixing/RetFitting1e12.pdf}
        \caption{}
        \label{subfig:retfitting1e12}
    \end{subfigure}
    \caption{Results from recovering the abundance of retinal fluorophores from additive mixtures using their fluorescence lifetime with the inclusion of detector shot noise for where (\subref{subfig:retfitting1e3}),(\subref{subfig:retfitting1e5}),(\subref{subfig:retfitting1e7}),(\subref{subfig:retfitting1e12}) denote photon fluxes of \numlist{e3;e5;e7;e12} respectively. The recovered abundances (middle row) are plotted with the ground truths (top row) and the error in the unmixing corresponding to \cref{eq:recerror} is plotted (bottom row). Areas shaded white represent where the fluorophore concentration is 0 and so a relative error cannot be ascribed (\cref{eq:recerror}).}
    \label{fig:retfitting}
\end{figure}

The results from these simulations, shown in \cref{fig:retfitting}, illustrates the rule-of-thumb for fitting fluorescence lifetimes that, in general, to fit $k$ lifetimes a photon flux on the order of $10^{2k +1}$ is required such that only at a photon count of \num{e12} (\cref{subfig:retfitting1e12}) does the error reduce below \SI{50}{\percent} for even larger relative concentrations of FAD, A2E, or AGE. For the cases of realistic photon fluxes (Fig.~\labelcref{subfig:retfitting1e3,subfig:retfitting1e5}) the images of the recovered abundances are predominantly uncorrelated with the ground truth abundance maps and this is also reflected the associated error map.


\FloatBarrier
\subsection{Appraisal of Technique}
To summarise, a method of recovering the relative concentrations of additive mixtures of retinal fluorophores AGE, A2E, and FAD using non-linear least squares fitting of a 6-exponential decay model was proposed and its sensitivity to these fluorophore concentrations, and photon shot noise, were investigated. It was found that even for exceedingly large photon fluxes the associated error in recovering these abundances was too high to reliably detect the presence of key retinal biomarkers or quantify their concentrations of. Likewise, for photon fluxes commensurate with those published in literature~\cite{dysli2017fluorescence} the recovered abundances are almost entirely uncorrelated with the ground truth abundances.
While improvements to future generations of SPAD arrays could increase the detection efficiency by at least an order of magnitude through: increasing fill-factor using micro-lens arrays and back-illuminated multi-layer fabrication; and improving the efficiency of the TCSPC modules with lower pixel dead-time to reduce the effects of photon pile-up this method would still not be suitable for mapping FAD concentrations in the retina within a realistic image acquisition time.
\FloatBarrier
\section{Phasor S-FLIM} \label{sec:phasor-sflim}
As was discussed in Chapter~\ref{sec:phasoranalysis}, phasor analysis presents as a fit free analysis tool for easy segmentation of flourophores but is a technique predominantly used for FLIM imaging of stained samples. To unmix combinations of fluorphores, the linear addition of phasors can be exploited such that the relative abundance of $N$ fluorophores can be unmixed using a technique akin to vertex component analysis where the phasors of the pure endmembers form the vertices of an $N$-polygon and the phasor of a fluorophore to be unmixed lies within that $N$-polygon as is illustrated in (\cref{fig:phasorbiunmix} for the case of unmixing 2 fluorophores. The robustness of this method suffers from the same issues that plague lifetime based unmixing - sensitivity to noise and similarity in endmember lifetime model.


\begin{figure}
    \centering
    \includegraphics[width = 0.7\textwidth]{figures/sflim/phasor-unmixing/PhasorUnmix.pdf}
    \caption{Depiction of unmixing a combination fluorophores using phasor analysis. For this mixture of 2 fluorophores the pure endmembers are represented as single exponential decays (black circle and green star) and thus have phasors lying on the unit circle. A third phasor consisting of a mixture of two fluorophores, with relative abundances $\alpha_{1}$ and $\alpha_{2}$, lies upon a line intersecting both endmember phasors. The relative abundances are recovered using the fractional lengths $f_{1}$ and $f_{2}$ : $\alpha_{1} = \frac{f_{1}}{f_{1} + f_{2}}$, $\alpha_{2} = \frac{f_{2}}{f_{1} + f_{2}}$ }
    \label{fig:phasorbiunmix}
\end{figure}

To address these limitations, \citeauthor{scipioni2021phasor} developed a method which utilises phasor analysis and now the spectrally resolved fluorescence decay which boasts the ability to unmix fluorophores with no prior knowledge of either the spectral or decay characteristics of the pure endmembers. While primarily intended for FLIM imaging of biological samples stained with dyes exhibiting well separated spectra and lifetime the capabilities of this technique for unmixing retinal fluorophores - exhibiting highly overlapping spectra and similar lifetimes - was investigated.
\subsection{The unmixing algorithm}
The full algorithm is fully discussed in \citeauthor{scipioni2021phasor} and its associated supplementary material as well as multiple examples of imaging in biological samples but will be briefly outlined here\cite{scipioni2021phasor}.
For a given spatial pixel, $I(x,y)$ the time-resolved fluorescence is recorded over multiple discrete spectral bands and the phasor transform is applied to yield 4D data-structure, $I(x,y,t,\lambda)$. From this the phasor transform is then applied using \cref{eq:phasor-g} and \cref{eq:phasor-s} evaluated at the first harmonic - $n=1$ - producing a series of spectrally-resolved phasors $g(\lambda)$ and $g(\lambda)$ from which any spectral calibration or temporal instrument response function can be corrected for. To extract the location of the endmembers within phasor space the individual spectral phasors, $g(\lambda)$ and $g(\lambda)$, coordinates are further transformed using Principle Components Analysis (PCA) to find the orientation of the spectral phasors which maximises the variability - making the location of the endmembers more pronounced. Finally, the $g$, and $s$ components of the PCA transformed phasors are fitted to a generalised double logistic function (\cref{eq:dublog}) to recover the endmember phasor locations from the $I_{+\infty,1}$, $I_{-\infty,1}$, and $I_{+\infty,2}$ terms. From the location of each endmember in phasor space the fluorescence decay profile and spectra are then reconstructed weighted by their relative abundance - enabling the quantification of fluorophore concentration. The authors note in the supplementary material that double-generalised logistic function was chosen to model the flexibly model the phasor representation of the endmember spectra through the $g_{k}$, $\Delta x_{k}$, and $v_{k}$ parameters and minimise the assumptions made about the broadness, emission peak, and general shape the endmember spectra. 
\begin{equation}
    f(x)  =  I_{-\infty,1}   +\frac{  I_{+\infty,1} + \frac{  I_{+\infty,2} - I_{-\infty,1}  }{\big(1 - \exp[-g_{2}(x - \Delta x_{2})]\big)^{\nicefrac{1}{v_{2}}}} - I_{-\infty,1}}{\bigg(1 - \exp[-g_{1}(x - \Delta x_{1})]\bigg)^{\nicefrac{1}{v_{1}}}}\label{eq:dublog}
\end{equation}
While this unmixing approach is primarily intended for the imaging scenarios of labelled samples where spectral overlap and lifetime similarity can be controlled through the choice of dyes its application to the unmixing of retinal fluorophores is attractive due to its reported robustness to low photon flux and spectral contamination due to autofluorescence from the sample. Notably its was hoped that this robustness to from sample autofluorescence could overcome signal contamination experienced in retinal imaging where the retinal autofluorescence signal is affected by spectral degradation from absorption and scattering in blood vessels to the influence of lens autofluorescence.
\begin{figure}
    \centering
    \begin{annotatedFigure}{\includegraphics[width = 0.8\textwidth]{figures/sflim/phasor-unmixing/SpectralPhasors.pdf}}
    \annotatedFigureText{0.02,0.99}{black}{0.3}{a)}
    \annotatedFigureText{0.51,0.99}{black}{0.3}{b)}
    \annotatedFigureText{0.02,0.49}{black}{0.3}{c)}
    \end{annotatedFigure}
    \caption{Fluorescence decay profiles, and emission spectra for retinal fluorophores AGE, A2E, and FAD are shown in the a) and b) respectively with a an example additive mixture shown as the dashed grey line. In c) the phasor representation of the spectrally resolved fluorescence decays of this mixture are represented as circular markers where the colour represents the spectral band. The phasors of the endmembers FAD, AGE, and A2E are shown as magenta, orange, and cyan triangles respectively.}
    \label{fig:spectralphasors}
\end{figure}
\subsection{Phasor S-FLIM performance for quantifying retinal fluorophores}
The sensitivity of this algorithm to fluorophore concentration and the effects of photon noise was examined using simulated SFLIM data produced in a similar fashion to the previously discussed fitting based approach (\cref{sec:lifeunmix}) where now in the case of shot-noise affected datasets the number of photons associated with the simulation are now distributed amongst 32 contiguous spectral bands - modelled with rectangular transmission functions - and \num{266} time bins as a additive mixtures.
The fluorescence emission spectra of AGE, A2E, and FAD was modelled by re-sampling Fig. 9 of \citeauthor{schweitzer2007towards} which shows the emission spectra of these retinal fluorophores. The fluorescence lifetime components for these fluorophores were also obtained from this same publication (Table 1 of \citeauthor{schweitzer2007towards}).
The phasor SFLIM algorithm was first evaluated using datasets with varying fluorophore abundances with no shot-noise applied which represent the theoretical maximal performance of the technique. In \cref{fig:phasorresultnoiseless}, the phasor SFLIM algorithm displays poor performance over all concentrations of FAD but this significantly pronounced at low fluorophore concentrations where the average error, computed using \cref{eq:recerror},  is in excess of \SI{100}{\percent}. This poor performance is in part due to the aforementioned close proximity of spectral phasors of AGE and FAD but was compounded by an artefact of the blind nature of the un-mixing technique where in relation to the ground truth the recovered spectra were often unpredictably misordered. To address this each recovered spectra was matched to its true endmember spectra and correctly ordered by finding which combination resulted in the maximum overlap (\cref{eq:sam}).

\begin{equation}\label{eq:sam}
    \varphi = \frac{\mathbf{a}\cdot \mathbf{b}}{\lvert \mathbf{a} \rvert\,\lvert \mathbf{b} \rvert}
\end{equation}

\begin{figure}
    \centering
    \includegraphics[width = 0.8\textwidth]{figures/sflim/phasor-unmixing/PhasorNoiselessResults.pdf}
    \caption{Results of unmixing additive mixtures of retinal fluorophores without the inclusion of any read-noise or shot-noise using the Phasor-SFLIM technique. The top row shows the ground truth relative abundances of the retinal fluorophores AGE, A2E (lipofuscin), and FAD which are varied between 0 and 1. The middle row shows the recovered abundances after the reconstructed spectra have been correctly ordered with the associated error - calculated using \cref{eq:recerror} - shown in the bottom row and is also scaled from 0 to 1.}
    \label{fig:phasorresultnoiseless}
\end{figure}

While, this poor performance even in the idealised case would immediately rule out this technique for \textit{in-vivo} imaging of human retinas the effects of shot-noise were also explored using a SFLIM dataset with the same number of spectral bands and time bins as before but now shot-noise corresponding to \num{e6} photons was applied. For each "pixel" or combination of relative fluorophore concentrations \num{100} samples were simulated, giving a total image size of \qtyproduct{100 x 100}{\pixel}, to reduce the effects of random outliers in the photon distribution of the temporal decays. The effects of this applied photon noise, as shown in \cref{fig:phasorresultsnoisy}, resulted in the same poor un-mixing performance where at low fluorophore concentrations the error in the recovered relative abundance is $\geq\SI{100}{\percent}$ and for the entire ``image'' the mean error in quantifying FAD concentration is \SI{224}{\percent}. 
\begin{figure}
    \centering
    \includegraphics[width = 0.8\textwidth]{figures/sflim/phasor-unmixing/PhasorResultsNoisy.pdf}
    \caption{Results of unmixing additive mixtures of retinal fluorophores using the Phasor - SFLIM technique with the inclusion of shot-noise. For each ``pixel'' the simulated SFLIM data has \num{e6} distributed over 32 contiguous spectral bands and each combination of fluorophore concentrations are sampled \num{100} to mitigate the effect of random outliers. The top row shows the ground truth relative abundances, varying from 0 to 1 of AGE, A2E, and FAD while the middle row shows the recovered abundances. The error - calculated using \cref{eq:recerror} - is shown in the bottom row and is also scaled from 0 to 1.}
    \label{fig:phasorresultsnoisy}
\end{figure}
\subsection{Appraisal of Phasor - SFLIM}
In literature the phasor-SFLIM technique has been shown to robustly un-mix fluorophores at low photon fluxes however this could be replicated for the case of simulated mixtures of retinal fluorophores~\cite{scipioni2021phasor,scipioni2022phasor}. The primary reason for this lies with the similarity of the retinal fluorophores with regard to their fluorescence emission spectra and fluorescence lifetime components which results in the phasors of pure AGE and FAD phasors to be in close proximity in phasor space - critically degrading the un-mixing performance. The technique exhibits a sufficiently high error even in the case of noise-free data that detecting the presence of FAD in the retina would not be possible. The success of this technique in literature can then be associated with the additional control that labelled imaging offers where dyes can be engineered to be well separated in phasor space which does not accurately represent the challenges inherent with imaging the retina. While this analysis did not attempt to model the spectral contamination due to the absorption of vascular blood the phasor S-FLIM algorithm can nonetheless be deemed to be unsuitable for quantifying retinal FAD and was not pursued further.

\FloatBarrier
\section{Spectral Unmixing}\label{sec:specunmix}
In the field of remote sensing the technique of spectral imaging is used for example, to separate buildings, from foliage, from rivers in the scene by their unique spectral signatures - buildings will appear spectrally flat, foliage will peak in the green, and rivers and water features will peak in the blue spectral regions. This is achieved by assuming in each pixel of an image, the recorded intensity is comprised of an additive mixture of pure endmembers, with unique spectral signatures) and concentrations or relative abundances.
\begin{align}
    I(x,y) = I_{0}\sum^{N}_{n \geq}\alpha_{n}S_{n}(\lambda) \text{ such that } \sum_{n \geq 1}^{N}\alpha_{n} = 1 \text{ and } \int_{0}^{\infty}S_{n}d\lambda = 1
\end{align}
These relative abundances, $\alpha_{n}$, can be recovered by recording images over multiple wavebands utilising this linear unmixing model and one of the many available recovery methods such as Non-negative matrix factorisation (NMF), Vertex / Geometric Component Analysis (VCA / GCA), Auto-encoder networks [review of spectral imaging techniques]. These methods differ not only in their robustness to noise but the amount of prior information required - VCA / GCA can be performed blindly with no prior knowledge of the endmember spectra. A common limitation to all of these methods is that of overlapping endmember spectra and low photon fluxes degrading the accuracy of the abundance recovery motivating the need for careful choice of the number and location of detection bands.
\\
For assessing the suitability of this method for unmixing retinal fluorophores the simplest method - matrix inversion - is considered. For a given spatial pixel with endmember abundances, $\mathbf{a}(n)$ and known endmember spectras, $\mathbf{S}(\lambda,n)$ the spectral measurements $\mathbf{m}(\lambda)$ are simply a linear mixture: 
\begin{align}
    \mathbf{M} &= \mathbf{S}\mathbf{a}\label{eq:specmix}
\end{align}
\begin{align}
    \mathbf{S} &= \begin{bmatrix} S_{0}(\lambda_{0}) & S_{0}(\lambda_{1}) & \cdots & S_{0}(\lambda_{j})\\ S_{1}(\lambda_{0}) & S_{1}(\lambda_{1}) & \cdots & S_{1}(\lambda_{j}) \\ \vdots & \vdots & \ddots & \vdots \\ S_{n}(\lambda_{0}) & S_{n}(\lambda_{1}) & \cdots & S_{n}(\lambda_{j}) \end{bmatrix} &
    \mathbf{M} &= \begin{bmatrix} M(\lambda_{0}) & M(\lambda_{1}) & \cdots & M(\lambda_{j}) \end{bmatrix} &
    \mathbf{a} &= \begin{bmatrix} a_{0} \\ a_{1} \\ \vdots \\ a_{n}\end{bmatrix}
\end{align}
The recovered endmember abundances, $\bar{\mathbf{a}}$ are then found using a simple matrix multiplication:
\begin{align}
    \bar{\mathbf{a}} &= \mathbf{S}^{-1}\mathbf{m} \label{eq:matinv}
\end{align}
For over determined systems - where the number of spectral measurements is greater than the number of unknown endmember abundances ($\lambda > n $)  - the matrix $\mathbf{S}$ is non-square and so the inverse $\mathbf{S}^{-1}$ doesn't exist. The Moore-Penrose Pseudo Inverse, denoted as $\mathbf{S}^{+}$ (\cref{eq:mpinvmatrix}), extends some useful properties of the traditional inverse (Eq.~\ref{eq:mpinvidentity}):
\begin{align}
    \mathbf{S}^{+} &= (\mathbf{S}^{T}\mathbf{S})^{-1}\mathbf{S}^{T} \label{eq:mpinvmatrix}
\end{align}
\begin{align}
    \mathbf{A}^{-1} &: \mathbf{A}^{-1}\mathbf{A} = \mathbb{I} \implies \mathbf{A}^{+}: \mathbf{A}\mathbf{A}^{+}\mathbf{A} = \mathbf{A} \label{eq:mpinvidentity}
\end{align}
As was previously mentioned, overlapping endmember spectra, and noise in the spectral measurements results in the abundances recovered using \cref{eq:matinv} deviating from the ground truth abundances. In practice, these ground truth abundances cannot be reliably known and so the metric of the matrix condition number (\cref{eq:matcondnum}) is used to estimate how noise and errors in measurements influence the recovered abundances. The matrix condition number captures how invertible the matrix $\mathbf{S}$ is and will be dependent on the endmember spectra that are being unmixed, the number of detection bands as well as the location of these bands and their width. Generally a condition number of $\kappa(\mathbf{S}) \propto 10^{k}$ results in a loss of precision of $k$ digits~\cite{cheney2012numerical}. For recovering the abundances of retinal fluorophores, which will vary between \qtyrange{0}{100}{\percent} or \numrange{0}{1}, a condition number of $\kappa(\mathbf{S}) < \num{e2}$ is required to have an error of less than \SI{10}{\percent}.
\begin{align}
    \kappa(\mathbf{S}) = \big\lvert\big\lvert \mathbf{S} \big\rvert\big\rvert_{F}\big\lvert\big\lvert \mathbf{S}^{+} \big\rvert\big\rvert_{F} \label{eq:matcondnum}
\end{align}
\begin{align}
    \bigg\lvert\bigg\lvert \frac{\delta \mathbf{a}}{\mathbf{a}} \bigg\rvert\bigg\rvert \leq \kappa(\mathbf{S})\bigg\lvert\bigg\lvert \frac{\delta \mathbf{m}}{\mathbf{m}} \bigg\rvert\bigg\rvert
\end{align}
\subsection{Optimisation of detection bands for retinal fluorophores}\label{sec:specunmixopt}
Additionally this condition number can utilised to optimise the 2 predominant approaches to recording spectral images: contiguous bands of equal width that span a designated wavelength range - this approach evenly samples the spectra with lower sensitivity to noise but sacrifices spectral resolution/specificity; and multiple narrower discrete bands which are chosen for the scene and the endmembers to be recovered in order to maximise the spectral specificity and reduce image acquisition time.
A simple exhaustive search for the optimal detection bands for unmixing retinal fluorophores was carried out to find the optimum location of the \num{6} detection bands for the S-FLIO system described in \cref{chap:fliodevice}. The fluorescence emission bandwidth (\qtyrange{500}{700}{\nm}) that the S-FLIO system can image over was divided into \num{40} contiguous, \SI{5}{\nm} wide, bands and the condition number was calculated for each of the $\binom{40}{6} \approxeq \num{3.8e6}$ possible detection configurations. This yields an optimal set of filters with cut-on wavelengths of \qtylist{500;535;630;640;655;660}{\nm} with a matrix condition number of $\kappa = \num{8.101}$ indicating an at most one digit of precision will be lost whereas the heuristically chosen bands with cut-on wavelengths of \qtylist{500;510;530;560;590;630}{\nm} gives a larger condition number of $\kappa = \num{10.761}$.
\begin{equation}\label{eq:nchoosek}
    \binom{n}{m} = \frac{n!}{k!(n-k)!}
\end{equation}
\begin{figure}
    \begin{subfigure}[b]{0.49\textwidth}
        \centering
        \includegraphics[width = \textwidth]{figures/sflim/spectral-unmixing/HeuristicBandsSpectra.pdf}
        \subcaption{}
        \label{subfig:retspectraheurstic}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.49\textwidth}
        \centering
        \includegraphics[width = \textwidth]{figures/sflim/spectral-unmixing/MatrixBandsSpectra.pdf}
        \subcaption{}
        \label{subfig:retspectraopt}
    \end{subfigure}
    
    \caption{Detection bands for spectral imaging superimposed onto fluorescence emission spectra of AGE, FAD, and A2E (blue, green and red lines, respectively) where (\subref{subfig:retspectraheurstic}) represents the bands chosen heuristically for the \textit{ex-vivo} rat imaging and (\subref{subfig:retspectraopt}) represents the bands which minimise the matrix condition number.}
    \label{fig:retspectrabands}
\end{figure}
Now, the performance of these two detection schemes can then be compared using the above abundance maps with  noiseless data and data consisting of \num{e5} detected photons and their associated shot noise as shown in \cref{fig:spectunmixheursiticbands,fig:spectunmixoptbands}. 

\begin{equation}\label{eq:RMSerror}
    \mathbf{\epsilon}_{RMS} = \sqrt{\frac{\sum_{n \geq 1}^{N}\mathbf{\epsilon}^{2}}{N}}
\end{equation}

\begin{figure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.65\textwidth]{figures/sflim/spectral-unmixing/SpectUnmixHeuristicBandsNoiseless.pdf}
        \subcaption{}
        \label{subfig:heuristbandsnoiseless}
    \end{subfigure}
    \vfill
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.65\textwidth]{figures/sflim/spectral-unmixing/SpectUnmixHeuristicBands1e5.pdf}
        \subcaption{}
        \label{subfig:heuristbands1e5}
    \end{subfigure}
    \caption{Relative abundances of retinal fluorophores recovered using spectral unmixing and 6 detection bands using heuristically chosen band locations under (\subref{subfig:heuristbandsnoiseless}) noiseless conditions and (\subref{subfig:heuristbands1e5}) \num{e5} photons with shot noise applied. For both (\subref{subfig:heuristbandsnoiseless}) and (\subref{subfig:heuristbands1e5}) the top rows represent the ground truth abundances, the middle rows are the recovered abundances, and the bottom row is the error defined using Eq.~\ref{eq:recerror}.}
    \label{fig:spectunmixheursiticbands}
\end{figure}


\begin{figure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.62\textwidth]{figures/sflim/spectral-unmixing/SpectUnmixOptBandsNoiseless.pdf}
        \subcaption{}
        \label{subfig:optbandsnoiseless}
    \end{subfigure}
    \vfill
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width = 0.62\textwidth]{figures/sflim/spectral-unmixing/SpectUnmixOptBands1e5.pdf}
        \subcaption{}
        \label{subfig:optbands1e5}
    \end{subfigure}
    
    \caption{Relative abundances of retinal fluorophores recovered using spectral unmixing and 6 detection bands optimised such that the matrix condition number is minimised under (\subref{subfig:optbandsnoiseless}) noiseless conditions and (\subref{subfig:optbands1e5}) \num{e5} photons with shot noise applied. For both (\subref{subfig:optbandsnoiseless}) and (\subref{subfig:optbands1e5})  the top rows represent the ground truth abundances, the middle rows are the recovered abundances, and the bottom row is the error defined using Eq.~\ref{eq:recerror}.}
    \label{fig:spectunmixoptbands}
\end{figure}

The errors in the noiseless unmixing are negligible (\num{1e-18}) and is supported by the vanishingly small RMS error: AGE = \SI{2.87e-12}{\percent}, A2E = \SI{1.04e-12}{\percent}, and FAD = \SI{5.00e-12}{\percent}. For the case of noise affected spectra - the error in the unmixing, and the difference in condition number becomes apparent where the RMS errors for optimised bands are up to \SI{4}{\percent} lower (Tab.~\ref{tab:spectunmixrms}).

\begin{table}
    \centering
    \begin{tabular}{|c|c|c|c|}
        \hline
        & AGE (\unit{\percent}) & A2E (\unit{\percent}) & FAD (\unit{\percent})\\
        \hline
        Opt. Bands - Noiseless & \num{2.87e-12} & \num{1.04e-12} & \num{5.00e-12}\\
        Opt. Bands - \num{e5} photons & \num{50.0} & \num{16.6} & \num{91.8}\\ 
         Heuristic Bands - Noiseless & \num{2.87e-12} & \num{1.04e-12} & \num{5.00e-12} \\
         Heuristic Bands - \num{e5} photons & \num{50.7} & \num{16.5} & \num{95.2} \\
         \hline
    \end{tabular}
    \caption{RMS errors of spectrally unmixing retinal fluorophores using matrix inversions using the heuristically chosen bands described in Chap.~\ref{chap:fliodevice} and bands chosen such that the matrix condition number is minimised under noiseless and shot noise affected conditions (\num{e5} photons)}
    \label{tab:spectunmixrms}
\end{table}

\subsection{Conclusions}
While spectral unmixing can in principle be used to unmix retinal fluorophores the large RMS error when unmixing FAD limits its efficacy for estimating the concentration of FAD in the retina beyond confirming the presence of FAD in a mixture of retinal fluorohpores. The RMS errors in the unmixing process also validate the bands that were chosen heuristically to coincide with the isobestic and non-isobestic points of the spectras of AGE, A2E, and FAD however the optimisation process could be improved to account for fluorescence emission filters with non-rectangular spectral response as well as the overall spectral response of the FLIO device. This simulation also only pinpoints the ideal detection bands within \SI{5}{\nm} increasing the resolution of this optimisation non-linearly increases the possible number of filter combinations and thus the computation time.
These results also highlights the key question of this thesis - ``What benefit do fluorescence lifetime bring to assessing retinal health'' which is addressed in the next section.

\FloatBarrier
\section{SFLIM unmixing using Tensor Inversions}
As has been discussed so far in this thesis, a suitable method for unmixing retinal fluorophores has not been identified. In the case of lifetime unmixing the error in the recovered abundances for realistic photon fluxes proved this technique would not be suitable primarily due to the similarity in the fluorescence lifetimes of the three fluorophores of interest (AGE, FAD, and A2E). The same limitation applies to Phasor S-FLIM but was also exasperated by the high spectral overlap of AGE, FAD, and A2E as well as the requirement to record SFLIM images over prohibitively large number of noisy spectral bands resulting exceedingly long image acquisition times.
\\
A new method has been developed which treats the temporal domain of SFLIM data as a pseudo-`spectra' and extends the matrix inversion approach of standard spectra unmixing to include the temporal domain. This combines the unique fluorescence decay profile inherent to a fluorophore as well as its emission spectra to minimise the effects of the high spectral and temporal overlap of retinal fluorophores. 
This new tensor based approach is constructed similarly to the matrix inversion method (\cref{eq:specmix}) and is shown in \cref{eq:tensmix}\,\footnotemark\, but briefly: the matrix containing the spectral characteristic of a pure endmember is replaced with a third-order tensor, $\mathcal{A}$, containing the spectrally resolved fluorescence decay of the pure endmembers; the array of spectral measurements is replaced with a matrix of spectrally resolved FLIM measurements, $\mathbf{M}$; the endmember abundances are still a simple vector, $\mathbf{x}$, where the endmember abundances all sum to unity.
\begin{align}
    \mathcal{A}\bullet_{3}\mathbf{x} &= \mathbf{M} \label{eq:tensmix}
\end{align}
\footnotetext{The operator ``$\bullet_{3}$'' represents the Tucker product along the third mode but in the case for the tensor $\mathcal{A}$,and vector $\mathbf{x}$ this numerically similar to a scalar product along the third dimension of $\mathcal{A}$. A more detailed description is given in App.~\ref{app:tensoralgebra}}
\begin{figure}[htbp]
\centering

\begin{tikzpicture}[every node/.style={anchor=north east,fill=white}, scale = 3]
\matrix (mA) [draw,matrix of math nodes]
{
\mathcal{A}_{0}(\lambda_{0}, t_{i}) & \mathcal{A}_{0}(\lambda_{1}, t_{i}) & \cdots & \mathcal{A}_{0}(\lambda_{j}, t_{i}) \\
\mathcal{A}_{1}(\lambda_{0}, t_{i}) & \mathcal{A}_{1}(\lambda_{1}, t_{i}) & \cdots & \mathcal{A}_{1}(\lambda_{j}, t_{i}) \\
\vdots & \vdots & \ddots & \vdots \\
\mathcal{A}_{n}(\lambda_{0}, t_{i}) & \mathcal{A}_{n}(\lambda_{1}, t_{i}) & \cdots & \mathcal{A}_{n}(\lambda_{j}, t_{i}) \\
};

\matrix (mB) [draw,matrix of math nodes] at ($(mA.south west)+(3em,1.5em)$)
{
\mathcal{A}_{0}(\lambda_{0}, t_{1}) & \mathcal{A}_{0}(\lambda_{1}, t_{1}) & \cdots & \mathcal{A}_{0}(\lambda_{j}, t_{1}) \\
\mathcal{A}_{1}(\lambda_{0}, t_{1}) & \mathcal{A}_{1}(\lambda_{1}, t_{1}) & \cdots & \mathcal{A}_{1}(\lambda_{j}, t_{1}) \\
\vdots & \vdots & \ddots & \vdots \\
\mathcal{A}_{n}(\lambda_{0}, t_{1}) & \mathcal{A}_{n}(\lambda_{1}, t_{1}) & \cdots & \mathcal{A}_{n}(\lambda_{j}, t_{1}) \\
};

\matrix (mC) [draw,matrix of math nodes] at ($(mB.south west)+(3em,1.5em)$)
{
\mathcal{A}_{0}(\lambda_{0}, t_{0}) & \mathcal{A}_{0}(\lambda_{1}, t_{0}) & \cdots & \mathcal{A}_{0}(\lambda_{j}, t_{0}) \\
\mathcal{A}_{1}(\lambda_{0}, t_{0}) & \mathcal{A}_{1}(\lambda_{1}, t_{0}) & \cdots & \mathcal{A}_{1}(\lambda_{j}, t_{0}) \\
\vdots & \vdots & \ddots & \vdots \\
\mathcal{A}_{n}(\lambda_{0}, t_{0}) & \mathcal{A}_{n}(\lambda_{1}, t_{0}) & \cdots & \mathcal{A}_{n}(\lambda_{j}, t_{0}) \\
};

\draw[dashed](mA.north east)--(mC.north east);
\draw[dashed](mA.north west)--(mC.north west);
\draw[dashed](mA.south east)--(mC.south east);
\draw[thick,-stealth] ([xshift=1ex]mC.south east) -- ([xshift=1ex]mA.south east)
  node[midway,below] {t};
 \draw[thick,-stealth] ([yshift=-1ex]mC.south west) -- 
  ([yshift=-1ex]mC.south east) node[midway,below] {$\lambda$};
 \draw[thick,-stealth] ([xshift=-1ex]mC.north west)
   -- ([xshift=-1ex]mC.south west) node[midway,above,rotate=90] {n};
  
\end{tikzpicture}

\caption{Visualisation of the $\mathcal{A}$ tensor in Eq.~\ref{eq:tensmix} composed of,$n$, unique endmembers with known spectra ($\lambda$ - axis) and fluorescence decay profiles ($t$ - axis).}
\label{fig:tensor}
\end{figure}

\subsection{SFLIM Unmixing method}
The mathematics used to carry out the matrix inversion method in \cref{sec:specunmix} are only well defined for matrices, vectors, and scalars i.e mathematical objects with 2 dimensions or fewer. This tensor based method utilises the work of~\citeauthor{brazell2013solving} which sought to extend the mathematical frameworks behind solving linear systems of equations to multi-linear systems of equations with the main contribution of this publication being their defining, and determining, the Moore-Penrose pseudo-inverses of higher-order tensors as well as describing a robust least-squares solving method using these inverses~\cite{brazell2013solving}.
The SFLIM unmixing method operates as follows, and is adapted from~\citeauthor{brazell2013solving}.
For the endmember tensors, $\mathcal{A}\in \mathbb{R}^{I \times J \times K}$, matrix of SFLIM measurements, $\mathbf{M}$, with, $I$ time bins, $J$, spectral measurements, and $K$ endmembers the optimal recovered relative abundances , $\mathbf{x}\in \mathbb{R}^{K}$, would satisfy the following minimisation:
\begin{equation}
    \mathbf{x} = \textit{min}\bigg\{\lvert\lvert \mathcal{A}\bullet_{3}\mathbf{x} - \mathbf{M} \rvert\rvert_{F} \bigg\}
\end{equation}
For a least squares method there is then the minimising function $\varphi(\mathbf{x}) = \big\lvert\big\lvert \mathcal{A}\bullet_{3}\mathbf{x} - \mathbf{M}\big\rvert\big\rvert_{F}^{2}$ with a Jacobian, $\nabla\varphi(\mathbf{x})$. An estimator of the relative abundances, $\bar{\mathbf{x}}$ can then be found at the critical point where $\nabla\varphi(\bar{\mathbf{x}}) = 0$.
First, an analytical expression for the Jacobian, $\nabla\varphi(\mathbf{x})$ is found by expanding $\varphi(\mathbf{x})$ using the identity of the Frobenius norm for order-2 tensors - $\big\lvert\big\lvert \mathbf{B} \big\rvert\big\rvert_{F}^{2} = \langle \mathbf{B}, \mathbf{B}\rangle \equiv \mathbf{B}^{T}\mathbf{B}$.
\begin{align}
    \varphi(\mathbf{x}) &= \langle\mathcal{A}\bullet_{3}\mathbf{x} - \mathbf{M}, \mathcal{A}\bullet_{3}\mathbf{x} - \mathbf{M}\rangle \\
    &= (\mathcal{A}\bullet_{3}\mathbf{x})^{T}(\mathcal{A}\bullet_{3}\mathbf{x}) - 2\mathbf{M}^{T}(\mathcal{A}\bullet_{3}\mathbf{x}) +  \mathbf{M}^{T}\mathbf{M}
\end{align}
The Jacobian, $\nabla\varphi(\bar{\mathbf{x}})$ is then found: 
\begin{align}
    \nabla\varphi(\mathbf{x}) = \pdv{\varphi(\mathbf{x})}{\mathbf{x}} = 2\mathcal{A}^{T} \ast_{2} \mathcal{A}\bullet_{3}\mathbf{x} - 2\mathcal{A}^{T}\ast_{2}\mathbf{M} \label{eq:jacfunc}
\end{align}
Next, using this expression for $\nabla\varphi(\mathbf{x})$, and the assumption that $(\mathcal{A}^{T} \ast_{2} \mathcal{A})^{-1}$ is square and non-singular i.e its inverse exists,  the estimator is then found by solving  $\nabla\varphi(\bar{\mathbf{x}}) = 0$:
\begin{align}
    \nabla\varphi(\bar{\mathbf{x}}) = 0 &= \mathcal{A}^{T} \ast_{2} \mathcal{A}\bullet_{3}\bar{\mathbf{x}} - \mathcal{A}^{T}\ast_{2}\mathbf{M}\\
    \mathcal{A}^{T} \ast_{2} \mathcal{A}\bullet_{3}\bar{\mathbf{x}} &= \mathcal{A}^{T}\ast_{2}\mathbf{M}\\
    (\mathcal{A}^{T} \ast_{2} \mathcal{A})^{-1}\ast_{2}(\mathcal{A}^{T} \ast_{2} \mathcal{A})\bullet_{3}\bar{\mathbf{x}} &= (\mathcal{A}^{T} \ast_{2} \mathcal{A})^{-1}\ast_{2}\mathcal{A}^{T}\ast_{2}\mathbf{M}
\end{align}
For $\mathbf{B} = \mathcal{A}^{T} \ast_{2} \mathcal{A}$, $\mathbf{B}$ is a matrix as thus has the property: $\mathbf{B}^{-1}\ast_{2}\mathbf{B} = \mathbb{I}_{K} $ yielding a final expression for $\bar{\mathbf{x}}$:
\begin{align}
        \mathbb{I}\bullet_{3}\bar{\mathbf{x}} &= (\mathcal{A}^{T} \ast_{2} \mathcal{A})^{-1}\ast_{2}\mathcal{A}^{T}\ast_{2}\mathbf{M}\\
        \implies \bar{\mathbf{x}} &= (\mathcal{A}^{T} \ast_{2} \mathcal{A})^{-1}\ast_{2}\mathcal{A}^{T}\ast_{2}\mathbf{M} \label{eq:xbar}
\end{align}

Using this mathematical framework the above SFLIM unmixing method, shown in \cref{alg:sflim} is implemented in \textit{python} using a combination of least-squares minimisation as well as Einstein Summations to represent the Einsten Prodcuts, $\ast_{2}$, and the Tucker Mode Products, $\bullet_{3}$ (See App.~\ref{app:tensoralgebra}). The use of a least-squares minimiser with the Jacobian (\cref{eq:jacfunc}) and Estimator (\cref{eq:xbar}) functions account for the high noise typically associated with SFLIM measurements as well as the similarity of the endmembers in the $\mathcal{A}$ tensor. For well conditioned and low noise problems the estimator $\bar{\mathbf{x}}$ can be evaluated directly to recover the relative abundance of endmembers.
\begin{algorithm}
    \caption{Algorithm for recovering endmember abundances from spectral FLIM data for a single spatial pixel}
    \label{alg:sflim}
    \begin{algorithmic}
    \Require$ \mathcal{A} \in \mathbb{R}^{I \times J \times K}\mbox{, } \mathbf{M} \in \mathbb{R}^{I \times J} $\mbox{ where $I = t$ - axis, $J = \lambda$ - axis, and $K =n$ - axis}
    \Require $\sum_{i,j}^{I,J}\mathcal{A} = 1$
    \Procedure{Least-Squares Minimisation}{$\mathcal{A}, \mathbf{M}$}
        \State $\mathbf{x}_{min} \gets \textit{least\textunderscore squares}(\text{Cost Function, Jacobian, Estimator})$
        \State $\mathbf{x}_{opt} = \nicefrac{\mathbf{x}_{min}}{\sum_{k}^{K}\mathbf{x}_{min}}$
    \EndProcedure
        \Procedure{Cost Function - $\varphi$}{$\mathcal{A}, \mathbf{M}, \mathbf{x}_{in}$}
            \State $\mathcal{A}\bullet_{3}\mathbf{x}_{in} \gets \textit{einsum}[ijk,k \rightarrow ij](\mathcal{A},\mathbf{x}_{in})$
            \State $\varphi \gets \sqrt{\sum_{i,j,k}^{I,J,K}\lvert\mathcal{A}\bullet_{3}\mathbf{x}_{in} - \mathbf{M}\rvert}^{2}$
        \EndProcedure
        \Procedure{Jacobian - $\nabla\varphi$}{$\mathcal{A}, \mathbf{M}, \mathbf{x}_{in}$}
            \State $\mathcal{A}^{T} \gets \text{permute axes of } \mathcal{A} : ijk \rightarrow kij$
            \State $\mathcal{A}\bullet_{3}\mathbf{x}_{in} \gets \textit{einsum}[ijk,k \rightarrow ij](\mathcal{A},\mathbf{x}_{in})$
            \State $\mathcal{A}^{T}\ast_{2}\mathcal{A}\bullet_{3}\mathbf{x}_{in} \gets \textit{einsum}[ijk,jk \rightarrow i](\mathcal{A}^{T}, \mathcal{A}\bullet_{3}\mathbf{x}_{in})$
            \State $\mathcal{A}^{T}\,\ast_{2}\mathbf{M} \gets \textit{einsum}[ijk,jk \rightarrow i](\mathcal{A}^{T},M)$
            \State $\nabla\varphi \gets 2\mathcal{A}^{T}\ast_{2}\mathcal{A}\bullet_{3}\mathbf{x}_{in} - 2\mathcal{A}^{T}\,\ast_{2}\mathbf{M}$
        \EndProcedure
        \Procedure{Estimator - $\bar{\mathbf{x}}$}{$\mathcal{A}, \mathbf{M}$}
            \State $\mathcal{A}^{T} \gets \text{permute axes of } \mathcal{A} : ijk \rightarrow kij$ 
            \State $\mathcal{A}^{T}\ast_{2}\mathcal{A} \gets \textit{einsum}[ijk,jkl \rightarrow il](\mathcal{A}^{T}, \mathcal{A})$
            \State $\mathcal{B} \gets (\mathcal{A}^{T}\ast_{2}\mathcal{A})^{-1}$
            \State $\mathcal{B}\ast_{2}\mathcal{A}^{T} \gets \textit{einsum}[ij, jkl \rightarrow ikl](\mathcal{B}, \mathcal{A}^{T})$
            \State $\bar{\mathbf{x}} \gets \textit{einsum}[ijk, jk \rightarrow i](\mathcal{B}\ast_{2}\mathcal{A}^{T},\mathbf{M})$
        \EndProcedure
    \end{algorithmic}
\end{algorithm}

\subsection{Evaluation of Performance}
The performance of this method can be defined using not only the sensitivity to noise used in the previous sections (\cref{sec:lifeunmix,sec:phasor-sflim,sec:specunmix}) but also using the condition number which allows for quick evaluations of performance over different band numbers as well as comparing this SFLIM based method with typical spectral unmixing or gated-FLIM techniques. 
The tensor condition number is calculated in much the same was as the conventional matrix condition number (\cref{eq:matcondnum}) except now the Frobenius norm is used rather than the $L^{2}$-norm which is restricted to 2 dimensions. Using the Frobenious norm also allows for the condition number of a matrix inversion process to be quantitatively compared to that of a tensor based inversion process.
\begin{equation}\label{eq:tensorinv}
    \mathcal{A}^{+} = (\mathcal{A}^{T}\ast_{2}\mathcal{A})^{-1}\ast_{2}\mathcal{A}
\end{equation}
\begin{equation}\label{eq:tensorcondnum}
    \kappa(\mathcal{A}) = \lvert\lvert \mathcal{A} \rvert \rvert_{F} \lvert\lvert \mathcal{A}^{+} \rvert \rvert_{F}
\end{equation}

\FloatBarrier
\subsection{Unmixing Retinal Fluorophores}\label{sec:tensband}
The abundance maps used in previous section (\cref{sec:lifeunmix,sec:phasor-sflim,sec:specunmix}) can be used to assess the efficacy of this S-FLIM unmixing method when unmixing retinal fluorophores and compare it to Phasor S-FLIM and traditional spectral unmixing using matrix inversions. Since this new tensor based method now incorporates the temporal decays as well as the spectral signatures of each fluorophore - resulting in another dimension to discriminate fluorophores in - the optimal detection bands may be different to that of traditional spectral unmixing. This could be, in part, due to some endmembers exhibiting high overlap in the spectral domain - which would ordinarily cause the unmixing problem to be ill-conditioned and highly sensitive to noise - but be very easily separable in the temporal domain. A slightly different was employed for optimising the detection scheme for the Tensor - Based S-FLIM. From the promising results seen in the previously demonstrated simulations, the detection scheme was now optimised based upon commercially available bandpass filters from the Edmund Optics catalogue of \num{43} different filters with central wavelengths ranging from \qtyrange{500}{700}{\nano\metre} and with bandwidths from \qtyrange{14}{84}{\nano\metre}. The performance metrics used in this new optimisation were also adapted to reflect such that detection schemes were favoured based upon minimising the condition number and maximising optical throughput using the additional Figure's-of-Merit (FoM's): $\nicefrac{\sqrt{BW}}{\kappa}$ which represents the shot-noise limited scenario; and $\nicefrac{BW}{\kappa}$ where now the scheme is read-noise limited. Here $BW$ represents an estimation of the optical throughput by simply calculating the fraction of the spectra covered by the filter set, and as before $\kappa$ represents the tensor condition number~(\cref{eq:tensorcondnum}). In the optimisation procedure the 2 FoM's and the tensor condition number were computed for each combination of 6 filters from the Edmund Optics Catalogue and of the $\approx 6$ million combinations the \num{100} combinations with the best performance were evaluated for their sensitivity to fluorophore concentration using the abundance maps described previously. Of these the combination of filters which produced the best RMS error (\cref{eq:RMSerror}) were chosen. As shown in \cref{fig:tensoptband} the optimisation procedure produced sets of filters with high spectral overlap but for the condition number metric the average RMS error was the lowest. In principle this results in redundant bands which would provide minimal gains in accuracy in the unmixing process at the expense of increased integration time and a higher average SNR due to the narrow bandwidth of the redundant filters. These overlapping filters were consolidated into a single band with a wider transmission window - reducing the number of bands from 6 to 4 where the three bands between \SI{500}{\nm} and \SI{575}{\nm} were retained. This final band was then re-optimised using the condition number and FoM , $\nicefrac{\sqrt{BW}}{\kappa}$, yielding the result in \cref{fig:tensoptband}d. While this approach does result in a slight increase in the RMS error in the recovery of FAD - $\epsilon_{FAD} = 0.724$ for the 4 filter set as opposed to $\epsilon_{FAD} = 0.618$ for the 6 filter set optimised for condition number - the higher optical throughput can either be leveraged for shorter SFLIM integration times or to increase the integration time per filter thus increasing the average SNR per spectral channel.


\begin{figure}
    \centering
        \begin{annotatedFigure}{\includegraphics[width = \textwidth]{figures/sflim/tensor-unmixing/SFLIMOptimisedBands.pdf}}
            \annotatedFigureText{0.01,0.95}{black}{0.3}{a)}
            \annotatedFigureText{0.34,0.95}{black}{0.3}{b)}
            \annotatedFigureText{0.68,0.95}{black}{0.3}{c)}
            \annotatedFigureText{0.01,0.50}{black}{0.3}{d)}
            \annotatedFigureText{0.52,0.50}{black}{0.3}{e)}
        \end{annotatedFigure}
    \caption{Sets of 6 filters optimised for SFLIM unmixing using 3 different performance metrics: $\kappa$ the tensor condition number (a); $\nicefrac{BW}{\kappa}$ which weights the condition number inversely the bandwidth of the filter set - mimicking a read-noise limited scheme (b); and $\nicefrac{\sqrt{BW}}{\kappa}$ where the condition number is now weighted with the square root of the bandwidth representing a shot-noise limited scheme (c). In d) and e) these 6 filters were further optimised to two sets of 4 filters by consolidating overlapping filters into a single wider band filter and re-optimising using the aforementioned performance metrics.}
    \label{fig:tensoptband}
\end{figure}

\begin{table}
    \centering
    \begin{tabular}{|c|c|c|c|c|}
        \hline
        \multicolumn{5}{|c|}{$\epsilon_{RMS}$ }\\
        \hline
        \multicolumn{2}{|c|}{} &  AGE & FAD & A2E \\
        \hline
       6 Filter Set & $\kappa$ & \num[round-mode = figures, round-precision = 3]{0.39716098} & \num[round-mode = figures, round-precision = 3]{0.61822781} & \num[round-mode = figures, round-precision = 3]{0.14949178}\\
         & $\nicefrac{\sqrt{BW}}{\kappa}$ & \num[round-mode = figures, round-precision = 3]{0.40467259} & \num[round-mode = figures, round-precision = 3]{0.64034744} & \num[round-mode = figures, round-precision = 3]{0.08565442}\\
         & $\nicefrac{BW}{\kappa}$ & \num[round-mode = figures, round-precision = 3]{0.31255062} & \num[round-mode = figures, round-precision = 3]{0.4163497} & \num[round-mode = figures, round-precision = 3]{0.12503993}\\
         \hline
         4 Filter Set & $\kappa$ & \num[round-mode = figures, round-precision = 3]{0.37950665} & \num[round-mode = figures, round-precision = 3]{0.72381184} & \num[round-mode = figures, round-precision = 3]{0.11899043}\\
         & $\nicefrac{\sqrt{BW}}{\kappa}$ & \num[round-mode = figures, round-precision = 3]{0.40303829} & \num[round-mode = figures, round-precision = 3]{0.7153356} & \num[round-mode = figures, round-precision = 3]{0.10026358}\\
         \hline
    \end{tabular}
    \caption{RMS error values - scaled from 0 to 1 for filter sets consisting of 6 and 4 spectral band obtained from optimising: condition number - $\kappa$; bandwidth weighted with condition number - $\nicefrac{BW}{\kappa}$ to mimic a read-noise limited detection scheme; and  bandwidth weighted with condition number modified to represent the case of shot-noise limited detection schemes -$\nicefrac{\sqrt{BW}}{\kappa}$.}
    \label{tab:SFLIMRMSerrors}
\end{table}

\section{SFLIM Imaging of FAD}\label{sec:retfad}
A successful unmixing method must be primarily be capable of detecting the presence of FAD at concentrations similar to the retina but also have the sensitivity to robustly changes in FAD concentration. To address this primary goal, the expected concentration of FAD in the retina is estimated by modelling the average metabolisation of oxygen and using this to infer the rate of production of FAD.
FAD in the body is produced through aerobic respiration wherein glucose and oxygen are metabolised produce carbon dioxide, water, and ATP the bodies usable energy source. Through the usage of ATP for other metabolic processes FAD and other flavoproteins such as Riboflavin are created as a byproduct.
\begin{equation}\label{eq:resp}
    \ce{C6H12O6 + 6O2 -> 6CO2 + 6H2O + ATP}
\end{equation}
The rate at which oxygen is metabolised, $Q_{\ce{O2}}$, is determined using ~\cref{eq:o2rate} from the average blood flow through the ophthalmic artery, $Q_{ret}$, and the relative change in saturation of blood entering, ${S\ce{O2}}_{in}$ and exiting it ${S\ce{O2}}_{out}$. The rate of blood flow through the ophthalmic artery was taken as $Q_{ret} = \SI{5}{\micro\litre\per\minute}$ by averaging two reported independent measurements recorded using different methods~\cite{dai2013absolute,riva1985blood}. Further, the oxygen saturation - the ratio of oxygenation to deoxygenated haemoglobin in the blood - has been reported as \SI{92.20}{\percent} and \SI{55.60}{\percent} for blood entering and exiting the ophthalmic artery~\cite{dunn2016physiology}.
\begin{equation}\label{eq:o2rate}
    Q_{\ce{O2}} = Q_{ret}({S\ce{O2}}_{in}-{S\ce{O2}}_{out})H
\end{equation}
Using~\cref{eq:o2rate} the rate of oxygen metabolisation was estimated to be $Q_{\ce{O2}}=\SI{3.155}{\micro\litre\per\minute}$ where $H=\num{0.285}$ is Hffners constant which is the volumetric ratio of oxygen to haemoglobin in the blood~\cite{dunn2016physiology}. The rate of FAD production, $Q_{FAD}$, can then be determined by considering that for every metabolised \ce{O2} molecule $k_{FAD} = 6$ molecules of FAD are produced with an efficiency of $\eta_{FAD} = \SI{1.3}{\percent}$~\cite{berg2007biochemistry, ames1992energy}.
\begin{equation}
    Q_{FAD} = Q_{\ce{O2}}N_{FAD}\eta_{FAD}
\end{equation}
This yields a production rate of $Q_{FAD} = \SI{0.123}{\micro\litre\per\min}$ which is then be converted to a steady state volume of FAD by assuming that all FAD in the retina is produced in the time taken for blood to flow through the retina and any FAD that is consumed is replaced upon the next circulation period of blood. With a blood flow period of $\delta T = \SI{4.7}{\second}$ measured as the time interval between blood entering and exiting the ophthalmic artery~\cite{khoobehi1990measurement}.
\begin{equation}
    V_{FAD} = Q_{FAD}\delta T
\end{equation}
With this calculated volume of FAD,$V_{FAD} = \SI{9.639}{\micro\litre}$, corresponds to $N_{FAD} = \SI{12.27}{\nano\mole}$ using \cref{eq:nummoles} with a $gfm_{FAD} =\SI{785.56}{\gram\per\mole}$, a density equal to that of water of $\rho_{FAD} = \SI{1} {\gram\per\milli\litre}$, and $N_{A} = \SI{6.022e23}{\per\mole}$.
\begin{equation}\label{eq:nummoles}
    N_{FAD} = V_{FAD}\rho_{FAD}gfm_{FAD}
\end{equation}
Finally, the result of~\cref{eq:nummoles} is expressed as a concentration by approximating the retina as a cuboid with thickness of \SI{344}{\um} and surface area of \SI{1361}{\milli\metre\squared} to estimate its volume~\cite{nagra2017determination, myers2015retinal}.
\begin{equation}\label{eq:FADconc}
    C_{FAD} = \frac{N_{FAD}}{V_{ret}} = \SI{26.9921}{\micro\mole\per\litre}
\end{equation}
While this analysis does represent a simplified interpretation of the biological functions in the retina it is commensurate with reported measurements of flavoproteins in rabbit eye's. In \citeauthor{batey1991analysis}, the concentration is defined as \SI{39.3}{\pico\mole\per\milli\gram} by weight of the retina which is within \SI{10}{\percent} of the estimation above when converted to equivalent units - $C_{FAD} = \SI{37.64}{\pico\mole\per\milli\gram}$ obtained using the result of \cref{eq:nummoles} and taking the mass of the retina as \SI{326}{\milli\gram}~\cite{batey1991analysis,feke1989blood}.

\subsection{\textit{Ex-Vitro} SFLIM Imaging of FAD}
The results of the above analysis were then used to imitate the expected photon flux produced by FAD in the retina and assess any additional challenge with unmixing FAD from two other selected dyes - Fluorescein and Rose Bengal. Aqueous solutions of FAD were prepared with concentrations equal to 0.1, 1, and 10 times the value of $C_{FAD}$ and the remaining solutions of dye were mixed into solutions of fluorescein and Rose Bengal where the relative photon 

\subsubsection{To Do}
\begin{itemize}
    \item finish analysis of FAD tube experiments
    \item write up FAD tube experiment
    \item conclusions for chapter
    \item re-read spectral unmixing section - likely some stuff that is not quite fully correct
\end{itemize}

% \subsubsection{Optimisation of Detection Scheme for Retinal Fluorophores}
% Since this new tensor based method now incorporates the temporal decays as well as the spectral signatures of each fluorophore - resulting in another dimension to discriminate fluorophores in - the optimal detection bands may by different to that of just spectral unmixing. This could be, in part, due to some spectral bands exhibiting high overlap in the spectral domain  - which would ordinarily cause the unmixing problem to be ill-conditioned and highly sensitive to noise - but be very easily differentiable in the temporal domain.
% The aforementioned optimisation procedure was then repeated for this SFLIM unmixing method for standard TCSPC based SFLIM measurements as well as gated FLIM detection consisting of 2 contiguous, \SI{2}{\ns} wide gates and and a truncated TCSPC based scheme where the nosiest bins are excluded - typically this is the final \numrange{50}{100} bins. The results of this optimisation shown in Fig.~\ref{fig:tensoroptbands} shows slightly different band locations to those optimised for spectral unmixing (See. Fig.~\ref{fig:spectunmixoptbands}) with the band positioned at \SI{630}{\nm} now having its cut-on wavelength shifted to \SI{670}{\nm} to optimise tensor unmixing (Fig.~\ref{subfig:optbandstensor}). The truncated tensor unmixing method (Fig.~\ref{subfig:optbandstrunc}) shares the same optimal band locations with standard tensor unmixing but the gated detection scheme is optimised when the band located at \SI{670}{\nm} is moved to \SI{665}{\nm}. This tensor unmixing method also appears to have increased performance over spectral unmixing and is displayed not only in a reduced condition number (See Tab.~\ref{tab:optcondnums}) but also a lower RMS-error when simulated data with \num{e5} photons is unmixing 



% \begin{table}
%     \centering
%     \begin{tabular}{|c|c|c|c|}
%         \hline
%         \multicolumn{2}{|c|}{Optimised} & \multicolumn{2}{|c|}{Heuristic}\\
%         \hline
%         Method & $\kappa$ & Method & $\kappa$\\
%         \hline
%         $T$ & \num{7.684} & $T$ & \num{9.439} \\
%         $T_{gated}$ & \num{8.005} & $T_{gated}$ & \num{10.287} \\
%         $T_{trunc}$ & \num{7.708} & $T_{trunc}$ & \num{9.488} \\
%         $S$ & \num{8.107} & $S$ & \num{10.761}\\
%         \hline  
%     \end{tabular}
%     \caption{Condition numbers, $\kappa$, for unmixing retinal fluorophores using tensor based and matrix based unmixing methods where: $T$ refers to the tensor based inversion method, $T_{gated}$ refers to the gated FLIM detection scheme consisting of 2 contiguous \SI{2}{\ns} gates, $T_{trunc}$ is a modification to the tensor inversion method where the final \num{100}, typically noisier, time bins are excluded, and finally $S$ is the spectral unmixing method using matrix inversions.}
%     \label{tab:optcondnums} 
% \end{table}

% \begin{figure}
%     \centering
%     \begin{subfigure}[b]{\textwidth}
%         \centering
%         \includegraphics[width = 0.6\textwidth]{figures/sflim/tensor-unmixing/TensorBandsSpectra.pdf}
%         \subcaption{}
%         \label{subfig:optbandstensor}
%     \end{subfigure}
%     \vfill
%     \begin{subfigure}[b]{\textwidth}
%         \centering
%         \includegraphics[width = 0.6\textwidth]{figures/sflim/tensor-unmixing/GatedBandsSpectra.pdf}
%         \subcaption{}
%         \label{subfig:optbandsgated}
%     \end{subfigure}
%     \vfill
%     \begin{subfigure}[b]{\textwidth}
%         \centering
%         \includegraphics[width = 0.6\textwidth]{figures/sflim/tensor-unmixing/TruncBandsSpectra.pdf}
%         \subcaption{}
%         \label{subfig:optbandstrunc}
%     \end{subfigure}
%     \caption{Optimised detection bands for unmixing retinal fluorophores using SFLIM measurements with the tensor based based inversion method. (\subref{subfig:optbandstensor}) shows the optimised bands for the tensor inversion method for TCSPC SFLIM data, (\subref{subfig:optbandsgated}) shows a slightly different detection scheme for a gated SFLIM detection scheme consisting of 2 contiguous gates of width \SI{2}{\ns}, and (\subref{subfig:optbandstrunc}) shows the optimal bands for a TCSPC detection scheme where the final 100 time bins are excluded.}
%     \label{fig:tensoroptbands}
% \end{figure}



% \begin{table}[]
%     \centering
%     \subfloat[][]
%     {
%         \begin{tabular}{|c|S[round-mode = figures, round-precision = 3]|S[round-mode = figures, round-precision = 3]|}
%         \hline
%         Method & $\kappa$ & $\delta\kappa$ \\
%         \hline
%         $T$ & \num{7.732364723572154} & \num{0.048781109014293556}\\
%         $T_{gated}$ & \num{8.034532947070025} & \num{0.029613222974138154}\\
%         $T_{trunc}$ & \num{7.758354669052182} & \num{0.050714853225379386}\\
%         \hline
%         \end{tabular}
%         \label{subtab:tenscondspec}
%     }
%     \subfloat[][]
%     {
%         \begin{tabular}{|c|S[round-mode = figures, round-precision = 3]|S[round-mode = figures, round-precision = 3]|}
%         \hline
%         Method & $\kappa$ & $\delta\kappa$ \\
%         \hline
%         $S_{tensor}$ & \num{8.157564497662399} & \num{0.05702337605193364}\\
%         $S_{gated}$ & \num{8.144941211643271} & \num{0.04440009003280565}\\
%         $S_{trunc}$ & \num{8.157564497662399} & \num{0.05702337605193364}\\
%         \hline
%         \end{tabular}
%         \label{subtab:speccondnumtensor}
%     }
%     \caption{Condition Number calculated using the optimal bands for the different detection schemes. (\subref{subtab:tenscondspec}) shows the condition number,$\kappa$, for the different tensor based schemes -Standard TCSPC SFLIM ($T$), Gated FLIM ($T_{gated}$), truncated SFLIM ($T_{trunc}$)) calculated using the bands optimised for Spectral unmixing. (\subref{subtab:speccondnumtensor}) where the condition number for the spectral unmixing method is calculated using the optimal bands for tensor based methods. The value, $\delta\kappa$, represents the difference between the highlighted method and the optimal bands for that unmixing method i.e. for $S_{gated}$, $\delta\kappa = S_{gated} - S_{opt}$ where $S_{opt}$ is the optimal bands for a spectral unmixing method (Tab.~\ref{tab:optcondnums}) and a positive $\delta\kappa$ indicates increased sensitivity to noise.}
%     \label{tab:condnumoptmix}
% \end{table}

% \subsubsection{Suitability for Different Unmixing scenarios}
% To ascertain the optimal use cases for this technique and reveal any deficiencies simulations involving fluorophores exhibiting different spectral and temporal characteristics were created to capture the 4 different scenarios that would be encountered in label free imaging: Well separated spectra and lifetimes; well separated spectra and similar lifetimes; overlapping spectra and well separated lifetimes; and finally overlapping spectra and similar lifetimes.
% For these 4 scenarios mono-exponential fluorescence decays were simulated with Gaussian spectra, filtered using contiguous, rectangular filters that span a given wavelength range.

% \begin{itemize}
%     \item Put in plots for condition number as a function of band number for the 4 situations highlighted above
%     \item plots suggest that Tensor Inversion could be a flexible, multipurpose analysis method and could be further developed by incorporated techniques from spectral unmixing such as VCA, NMF, etc. to potentially make this a blind unmixing method
% \end{itemize}
% \section{Conclusion}
% \begin{itemize}
%     \item The feasibility of unmixing FAD, and quantifying its concentration, from spectrally resolved fluorescence lifetime data was investigated and multiple approaches were compared.
%     \item Phasor -SFLIM is unsuitable due to the phasor of retinal fluorophores being located close together within phasor space. The effects of noise can mean the phasors of two retinal fluorophores can overlap and thus can't be discriminated from one another
%     \item A new technique called Tensor inversion was developed which mimics spectral unmixing but is capable of unmixing retinal fluorophores from SFLIM data with the same performance as standard spectral unmixing. 
%     \item The effects of shot noise are what predominatly affect the accuracy of the unmxing method when compared to spectral unmixing. For equal photon fluxes fewer measurements (spectral imaging) carry comparatively less noise than a larger number of measurements (SFLIM)
%     \item The techniques suitability may then lie in SFLIM imaging of stained samples or stain free imaging scenarios where the endogenous fluorophores exhibit less severe overlap in the spectral and temporal domain when compared to retinal fluorophores. 
%     \item Further work on in-vivo samples is required to fully characterise the technique - rat eye, perfused rabbit eyes, stained samples etc.
% \end{itemize}

\FloatBarrier
